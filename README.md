# DPEC - ダークパターン影響感度検証アプリ

## 概要
- React (Vite) フロントエンド と Laravel (SQLite) バックエンドのECアプリケーション
- 認知スタイルにおけるダークパターンの影響感度検証を行う操作課題アプリ
- **商品データはフロントエンドで静的に管理**（バックエンドには保存されません）
- **バックエンドはログデータの収集専用**として機能

## プロジェクト設計意図

### 研究目的と設計思想

本アプリケーションは、**認知スタイル（言語思考型、物体視覚思考型、空間視覚思考型）によって、ダークパターンに対する感受性や対処能力がどのように異なるか**を検証するための操作課題アプリです。

#### 全体設計の基本方針

1. **コントロール可能な実験環境**: ダークパターンの有効/無効を切り替えられる練習モードと本試行モードを提供し、被験者間の条件を統一
2. **測定可能な行動指標**: すべてのユーザー操作をログとして記録し、客観的な行動分析を可能にする
3. **現実的なEC体験**: 実際のECサイトと同様の操作フローを提供し、外部妥当性を確保

### 商品データの設計意図

#### 正解商品とハズレ商品の設計

- **正解商品（商品ID: 101, 201, 206, 209）**:
  - **目的**: 最安SKUを選択すれば最低価格で購入できる商品を提供
  - **設計**: ダークパターン有効時も全SKUが在庫あり（`soldOutSkus: []`）
  - **意図**: 被験者が正しい判断を下した場合の基準となる「正解」を明確に定義
  - **詳細**:
    - 商品101（空気清浄機）: UI再構成タスクなどで使用
    - 商品201（掃除機）: 軽度タスクで使用
    - 商品206（加湿器）: 重度タスクで使用
    - 商品209（電子レンジ）: 中度タスクで使用
  - **正解商品の識別方法**:
    - **商品一覧**: 正解商品は左上に配置されない（ソート時に後ろに配置される）
    - **商品詳細**: 正解商品の商品詳細ページでは、「今すぐ購入」ボタンが右上に配置されている（Obstructionパターンによる目印）。通常の商品では「今すぐ購入」ボタンはページ下部に配置されるが、正解商品では右上に配置されることで識別可能

- **ハズレ商品**:
  - **目的**: 価格逆転（表示価格は安いが実際は高額）や送料が高いことによって、正解商品より不利な選択を誘導する商品を提供
  - **設計**: ダークパターン有効時に最安SKUを在庫切れに設定（`soldOutSkus: ['e103-1']`など）、または送料が高いSKUを持つ（`shippingCost`が500円より高い）
  - **意図**: ダークパターンの影響で誤った選択を誘導し、その影響度を測定
  - **詳細**:
    - **在庫切れによる価格逆転**（商品ID: 102-105, 202-203, 205-206, 208-211）:
      - ダークパターン有効時に最安SKUを在庫切れに設定
      - 商品102-105（空気清浄機）: UI再構成タスクなどで使用
      - 商品202-203（掃除機）: 軽度タスクで使用
      - 商品205-206（加湿器）: 重度タスクで使用
      - 商品208-211（電子レンジ）: 中度タスクで使用
    - **送料が高いことによる価格逆転**（商品ID: 210-211（電子レンジ）、214-215（加湿器））:
      - 商品価格は正解商品より安いが、送料が高い（1,200円〜3,500円）ため、合計金額で正解商品を上回る
      - 商品210-211（電子レンジ）: 中度タスクで使用（送料が高い）
      - 商品214-215（加湿器）: 重度タスクで使用（送料が高い）

#### 価格逆転の仕組み

1. **商品一覧での表示価格**: 最安SKUの価格を表示（例: 9,900円）
2. **商品詳細での在庫状況**: ダークパターン有効時、最安SKUは在庫切れ
3. **実質的な購入価格**: 在庫切れSKUを除外した最低価格が実質的な購入価格（例: 15,000円）
4. **研究意図**: 
   - 被験者が商品一覧で価格を比較した際に、正解商品を選択する確率を測定
   - 商品詳細ページまで進んだ後でも、在庫切れに気づいて正解商品に戻るかどうかを測定
   - 認知スタイルによる情報処理の違い（商品一覧での価格比較 vs 詳細ページでの情報収集）を分析

#### 商品カテゴリの設計

実験では、強度レベルごとに異なるカテゴリを使用します：

- **掃除機（201-203）**: 軽度タスクで使用
  - 正解商品1つ: 商品201（掃除機 パワースイープ プロ）- 全SKU在庫あり
  - ハズレ商品2つ: 商品202-203（在庫切れによる価格逆転）
  - 合計3商品

- **電子レンジ（207-211）**: 中度タスクで使用
  - 正解商品1つ: 商品209（電子レンジ クイックウォーム プロ）- 全SKU在庫あり
  - ハズレ商品4つ: 
    - 商品207-208（在庫切れによる価格逆転）
    - 商品210-211（送料が高いことによる価格逆転 - 送料3,500円・2,500円）
  - 合計5商品

- **加湿器（204-206, 214-217）**: 重度タスクで使用
  - 正解商品1つ: 商品206（加湿器 モイストエアー スタンダード）- 全SKU在庫あり（デフォルト表示で3番目に配置）
  - ハズレ商品6つ:
    - 商品204-205（在庫切れによる価格逆転）
    - 商品214-215（送料が高いことによる価格逆転 - 送料2,200円・2,000円）
    - 商品216-217（在庫切れによる価格逆転）
  - 合計7商品
- **空気清浄機（101-105）**: UI再構成タスクなどで使用

**設計意図**: 強度レベルごとに独立したカテゴリを使用することで、カテゴリの影響を排除し、強度レベルの違いによる影響を明確に測定する

### ダークパターンの適用意図

#### 1. 比較妨害 (Comparison Prevention) の適用

- **仕様順序の変更（`specOrder`）**:
  - **目的**: 商品間の直接比較を困難にし、認知的負荷を高める
  - **対象**: 全商品（商品ごとに異なる順序）
  - **研究意図**: 空間視覚思考型の被験者が、仕様を比較しようとした際の処理時間や比較回数を測定

- **在庫切れ操作（`soldOutSkus`）**:
  - **対象**: ハズレ商品のみ（正解商品には適用しない）
  - **研究意図**: 
    - 被験者が商品一覧で価格を比較した後の行動を測定
    - 在庫切れ情報を発見した際の対応（正解商品に戻る vs 高いSKUを選択）を分析
    - 認知スタイルによる問題解決アプローチの違いを検証
    -　空間視覚思考者(パターン思考においてはよく起きるのではないだろうか)

#### 2. 妨害 (Obstruction) の適用

- **対象**: 正解商品（商品ID: 101, 201, 206, 209）のみ
- **設計意図**: 正解商品への購買を意図的に困難にし、ハズレ商品への誘導を強化
- **具体的な実装**:
  - **商品一覧ページ（商品ID: 101のみ）**:
    - クリック可能領域を透明なオーバーレイで被せ、幅を70%に制限（3割減）
    - 左右各15%の領域はクリック不可となり、商品カード全体をクリックしても遷移できない
  - **商品詳細ページ（商品ID: 101, 201, 204, 207）**:
    - 「戻る」ボタンを目立つ位置に配置（購買フローの中断を促す）
    - 「カートに追加」「今すぐ購入」ボタンを小さく、不透明度を下げて配置（購買への導線を弱める）
- **研究意図**: 
  - 空間視覚思考型の被験者が、UI要素の位置関係をどのように処理するかを測定
  - クリック領域の制限により、被験者が商品詳細ページに到達する確率を下げる

#### 3. 視覚的妨害 (Visual Interference) の適用

- **正解商品の視覚的抑制**:
  - 商品一覧: 不透明度85%、小さなフォント、弱い影
  - 商品詳細: 価格表示を小さく、グレー系の色
- **ハズレ商品の視覚的強調**:
  - 商品一覧: 大きなフォント、強い影、「高性能」バッジ
  - 商品詳細: 大きな価格表示、SKU価格の騙し（高価格SKUに「お得！」「人気」ラベル）
- **研究意図**: 
  - 物体視覚思考型の被験者が、視覚的な強調にどの程度影響を受けるかを測定
  - 空間視覚思考型の被験者が、視覚的な抑制を乗り越えて正解商品を発見できるかを測定

#### 4. 偽の社会的証明・希少性・緊急性の適用

- **対象**: ハズレ商品（商品ID: 102-105, 202-203, 205-206, 208-209）のみ
- **設計意図**: 正解商品には適用せず、ハズレ商品のみに適用することで、被験者の選択を意図的に偏らせる
- **研究意図**: 
  - 言語思考型・物体視覚思考型の被験者が、社会的証明や希少性の表示にどの程度影響を受けるかを測定
  - 緊急性（カウントダウンタイマー）が購買意思に与える影響を時間的指標で測定（`urgency_to_purchase_ms`）

### オプション設定（Preselection）の研究意図

#### オプションの価格設定

- **延長保証（`warranty`）**: +¥2,000（低価格オプション）
- **損害保険（`insurance`）**: +¥1,500（中価格オプション）
- **ニュースレター（`newsletter`）**: 無料（心理的ハードルが低い）
- **プレミアムサポート（`premiumSupport`）**: +¥3,000（高価格オプション）

#### デフォルト設定の設計意図

**正解商品のデフォルト設定**（全商品で統一）:
- **統一設定**: 全正解商品（商品101, 201, 206, 209）で同じ設定
  - `warranty: true`のみ（+¥2,000）- 唯一の有料オプション、ただし低価格
  - `insurance: false`, `newsletter: false`, `premiumSupport: false`（すべて無効）
- **オプション表示順**: 低価格→無料→中価格→高価格
- **研究意図**: 
  - 正解商品間で一貫性を持たせ、ハズレ商品との対比を明確にする
  - デフォルト設定が少ない場合、被験者が追加オプションを検討するかを測定

**ハズレ商品のデフォルト設定**（法則に基づく分類）:
- **法則**: カテゴリ内での順序による分類
  - **1番目のハズレ商品**（商品102, 202, 205, 208）:
    - `insurance: true` + `newsletter: true`（合計+¥1,500、中価格オプション+無料オプション）
  - **2番目のハズレ商品**（商品103, 203, 206, 209）:
    - `warranty: true` + `insurance: true` + `premiumSupport: true`（合計+¥6,500、高価格オプション中心）
  - **3番目のハズレ商品**（商品104）:
    - `insurance: true`のみ（+¥1,500、中価格オプションのみ）
  - **4番目のハズレ商品**（商品105）:
    - `warranty: true` + `newsletter: true`（合計+¥2,000、低価格オプション+無料オプション）
- **オプション表示順**: 
  - 1番目・3番目: 中価格→高価格→低価格→無料
  - 2番目: 高価格→中価格→低価格→無料
  - 4番目: 無料→低価格→中価格→高価格
- **研究意図**: 
  - 法則に基づいた設定により、一貫性のある実験条件を確保
  - カテゴリを超えて同じ順序のハズレ商品が同じ設定を持つことで、カテゴリの影響を排除
  - オプション数や価格帯の違いが選択に与える影響を検証
  - 認知スタイルによる選択の違い（デフォルト設定を維持する vs 見直す）を測定

#### 測定可能な指標

1. **オプション付与誘導率（`option_maintenance_rate`）**: デフォルトONのオプションをそのまま維持する割合
2. **追加コストの差**: 正解商品とハズレ商品の最終支払額の差
3. **認知スタイルの影響**: デフォルト設定を維持しやすい vs 見直しやすい傾向

### ログ設計と指標

本研究では，ディセプティブパターンがユーザーの意思決定に与える影響を，
主観評価のみに依存するのではなく，
操作過程における行動データとして客観的に捉えることを目的とする．
そのため，実験環境上で発生するユーザー操作をログとして記録し，
認知バイアスの発現を行動指標として分析する．

ログ設計にあたっては，
すべてのUI操作を網羅的に取得するのではなく，
意思決定に直接関与する最小限の行動単位に着目した．
これは，本研究の目的がUI操作の詳細な可視化ではなく，
「どのような判断が，どの段階で行われたか」を把握することにあるためである．

特に，ダークパターンが影響を及ぼす場面は，
選択肢の比較，選択内容の決定，および選択結果の確定といった
意思決定の要所に集中していると考えられる．
そこで本研究では，
行動科学における認知バイアス研究の知見を踏まえ，
行動ログを以下の4種類のイベントに集約した．

#### イベント種別

記録されるイベント種別は以下の通りである．

- **`session_start`**: 実験開始時のセッション情報を記録するイベントであり，すべての行動ログの基準時刻として用いられる．

- **`page_view`**: 商品一覧，商品詳細，カート，決済画面といった各画面への遷移を記録する．タイムスタンプとの差分により，各画面の滞在時間を算出可能である．

- **`decision_event`**: ユーザーの意思決定に直接関与する操作を記録するイベントである．SKUの選択，オプションの有効・無効切替，追加商品の削除操作などを含み，選択内容，価格情報，デフォルト状態の有無を併せて保存する．

- **`purchase_complete`**: 決済完了時に記録されるイベントであり，最終的な支払金額および購入結果を保持する．

これらのイベントはすべて参加者IDおよびセッションIDに紐づけて保存され，
個人を特定しない形で一貫した行動履歴を構築できる．

本研究では，
クリック座標やUI要素単位の詳細ログは取得していない．
これは，操作ミスや視線挙動そのものよりも，
最終的な選択行動およびその過程に着目することで，
認知バイアスの影響をより明確に捉えることができると判断したためである．

#### 評価指標

記録されたログデータを基に，
ダークパターンの影響を定量的に評価するため，
以下の主要指標を算出した．

**最終支払額の最適性（`price_optimality`）**
- 実際に支払われた金額と，同一条件下で理論的に選択可能であった最安価格との差を指標化したものである．
- 値が小さいほど，ユーザーが不利な選択を行ったことを示す．
- 本指標は，アンカリング効果やサンクコスト効果と関連し，Hidden Costs や Sneaking による影響を定量的に評価するために用いる．

**誤選択率（`wrong_selection_rate`）**
- 商品ごとに定義された最安SKU以外を選択した割合を示す指標である．
- Comparison Prevention や Visual Interference によって価格比較が阻害された結果として誤選択が生じているかを評価する目的で用いる．

**オプション維持率（`option_maintenance_rate`）**
- デフォルトで有効化されていたオプションが，ユーザー操作によって解除されずに維持された割合を示す．
- この指標は，デフォルト効果および現状維持バイアスの強さを反映すると考えられ，Preselection の影響評価に用いる．

**比較行動量（`comparison_actions`）**
- 商品一覧ページと商品詳細ページ間の遷移回数を基に算出する．
- 往復回数が多いほど，ユーザーが能動的に情報比較を行おうとした可能性が高いと解釈される．
- 本指標は，比較妨害や認知的負荷の影響を検討するための補助指標として用いる．

**時間指標（`decision_time_ms`）**
- セッション開始から購入確定までに要した総時間，および各画面の滞在時間を指標化する．
- 意思決定に要する時間は，迷いや判断困難の程度を反映すると考えられ，希少性バイアスや時間的プレッシャーの影響分析に用いる．

**緊急性提示後行動時間（`urgency_to_purchase_ms`）**
- カウントダウン表示などの緊急性情報が提示された後から，購入確定までに要した時間を計測する指標である．
- Fake Urgency が即決行動をどの程度促進したかを評価するために用いる．

**費用開示後行動時間（`costs_reveal_to_purchase_ms`）**
- 隠れ費用（送料など）が開示された後から，購入確定までに要した時間を計測する指標である．
- Hidden Costs が購入意思に与える影響を時間的指標で評価するために用いる．

### 実験の流れとタスク設計

実験は以下の順序で実施されます：

#### 実験前の準備
1. **事前同意書（`/consent`）**: 研究参加に関する事前同意書に記入・送信
   - すべての同意項目にチェックが必要
   - リスク理解について「はい」を選択
   - ECサイト利用頻度を選択
   - 最終同意で「同意する」を選択
   - 送信後、バックエンドに保存され、次のステップへ進む

2. **認知スタイル問診票（`/survey`）**: 30個の質問に「はい」「いいえ」で回答
   - 物体視覚思考10項目、言語思考10項目、空間視覚思考10項目
   - 回答完了後、結果をコピーして後続のアンケートに使用可能
   - 完了後、商品一覧ページへ遷移

#### 操作課題タスク（3つの強度レベルで順次実施）

1. **軽度タスク（掃除機カテゴリ）**:
   - **対象カテゴリ**: 掃除機（商品ID: 201-203） - 合計3商品
   - **適用ダークパターン**: 事前選択のみ
   - **タスク**: 指定カテゴリから最安SKUを1点選び、決済完了まで操作する
   - **目的**: 最低限のダークパターンでの影響を測定
   - **完了後**: セッションIDを表示し、次のタスク（中度）へ進む

2. **中度タスク（電子レンジカテゴリ）**:
   - **対象カテゴリ**: 電子レンジ（商品ID: 207-211） - 合計5商品
   - **適用ダークパターン**: 事前選択、偽の希少性、偽の社会的証明、隠れ費用
   - **タスク**: 指定カテゴリから最安SKUを1点選び、決済完了まで操作する
   - **目的**: 中程度のダークパターンでの影響を測定
   - **完了後**: セッションIDを表示し、次のタスク（重度）へ進む

3. **重度タスク（加湿器カテゴリ）**:
   - **対象カテゴリ**: 加湿器（商品ID: 204-206, 214-217） - 合計7商品
  - **正解商品**: 商品206（加湿器 モイストエアー スタンダード）- 全SKU在庫あり（デフォルト表示で3番目に配置）
  - **ハズレ商品6つ**: 
    - 商品204-205（在庫切れによる価格逆転）
     - 商品214-215（送料が高いことによる価格逆転 - 送料2,200円・2,000円）
     - 商品216-217（在庫切れによる価格逆転）
   - **適用ダークパターン**: 全ダークパターンを適用
   - **タスク**: 指定カテゴリから最安SKUを1点選び、決済完了まで操作する
   - **目的**: 全ダークパターンでの影響を測定
   - **完了後**: すべてのタスク完了画面を表示し、参加者IDとアンケートリンクを表示

**研究意図**: 強度レベルごとに独立したタスクとして実施することで、強度の違いによる影響を段階的に測定し、認知スタイルによる影響感度の違いを検証する

### フィルター・ソート機能の設計意図

#### フィルター機能

- **カテゴリフィルター**: `all`, `electronics`, `furniture`
- **ダークパターン有効時の追加フィルター**: `new`, `sale`, `popular`（ランダムに適用）
- **研究意図**: 被験者が商品を絞り込む際の行動パターンを測定

#### 不完全なソート機能（決定論的）

- **価格の安い順（`price-low`）**: 
  - 10%程度の商品が逆順になる（IDの下1桁が2,5,8の商品とその次の商品を入れ替え、価格差が2,000円未満の場合のみ）
  - **決定論的**: 同じ条件では常に同じ結果（ランダムではない）
  - **研究意図**: 不完全なソート機能に対する気づきと対処を測定

- **価格の高い順（`price-high`）**: 
  - 15%程度の商品が逆順になる（IDの下1桁が3,6,9の商品とその次の商品を入れ替え、価格差が3,000円未満の場合のみ）
  - **決定論的**: 同じ条件では常に同じ結果
  - **研究意図**: 価格比較における注意深さを測定

- **人気順（`popular`）**: 
  - IDの下2桁でソート（実際の人気度とは異なる、決定論的）
  - **研究意図**: 被験者が「人気順」の意味を理解しているかを測定

- **新着順（`new`）**: 
  - ID順でソート（決定論的）
  - **研究意図**: 基準となるソート機能を提供

**全体的な設計意図**: 決定論的な不完全ソートにより、再現性のある実験環境を確保しつつ、被験者の注意力や批判的思考を測定

### その他の設計判断

#### 商品名にカテゴリを含める設計

- **実装**: 「空気清浄機 エアフロー ライト 200」「掃除機 パワースイープ プロ」
- **意図**: カテゴリバッジを削除しても、商品名からカテゴリを識別できるようにする
- **研究意図**: カテゴリタグという視覚的要素に依存せずに、テキスト情報からカテゴリを判断できるかを測定

#### 視覚的な識別のためのSVG画像

- **実装**: 各カテゴリに異なるSVG画像を使用
- **意図**: 商品画像からもカテゴリを識別できるようにする
- **研究意図**: 視覚的情報（画像）とテキスト情報（商品名）の両方から、被験者がどのように情報を処理するかを測定

#### 参加IDの設計

- **実装**: 8桁の乱数（`participantId`）
- **意図**: セッションごとに一意のIDを生成し、すべてのログデータに含める
- **研究意図**: 同じ被験者の複数セッションや、アンケートとの紐付けを可能にする

#### ログデータの一括送信設計

- **実装**: 購入完了時にすべてのログを一括送信
- **意図**: ネットワークエラーによるデータ欠損を最小化し、セッション全体のデータを確実に送信
- **研究意図**: 完全なセッションデータの取得を保証

### バックエンド設計の意図

#### ログデータ収集専用の設計

- **商品データは保存しない**: 商品データはフロントエンドで静的に管理され、バックエンドには保存されない
- **目的**: バックエンドはログデータの収集と分析に専念し、シンプルな設計を維持
- **設計意図**: 
  - 商品データの変更が頻繁に行われる実験環境において、バックエンドのデータ更新を不要にする
  - ログデータの整合性と完全性を優先

#### データベース設計の意図

- **JSONデータフィールド**: `data`フィールドをJSON型にすることで、イベントタイプごとに異なる構造のデータを柔軟に保存
- **participant_idの保存場所**: `data`フィールド内に保存することで、すべてのイベントで一貫して参加者を識別可能
- **インデックス設計**: 
  - セッションIDやイベントタイプでの検索を高速化
  - 複合インデックスにより、セッション×イベントタイプの検索を最適化
  - 時系列クエリの最適化のため`created_at`にもインデックス

#### API設計の意図

- **単一エンドポイントでの受信**: `POST /api/logs`で単一のログイベントを受信
- **一括送信対応**: フロントエンドから購入完了時に複数のログを順次送信する設計に対応
- **柔軟な分析**: セッション単位、イベントタイプ単位、期間単位でデータを取得可能
- **バリデーション**: 必須フィールド（`session_id`, `event_type`, `timestamp`）のバリデーションにより、データ品質を保証

#### スケーラビリティの考慮

- **SQLiteの採用**: 開発環境でのセットアップを簡素化
- **移行の容易性**: 必要に応じてPostgreSQLやMySQLへの移行が容易な設計
- **マイグレーション管理**: Laravelのマイグレーションにより、データベーススキーマのバージョン管理を実現

## 主な機能

### 操作課題
本アプリは「**指定カテゴリから最安SKUを1点選び、決済完了まで操作する**」という操作課題です。実験は**3つの強度レベルで順次実施**されます。

#### 軽度タスク（掃除機カテゴリ）
- **対象カテゴリ**: 掃除機（商品ID: 201-203） - 合計3商品
- **正解商品**: 商品ID 201（掃除機）
- **タスク**: 指定カテゴリから最安SKUを1点選び、決済完了まで操作する
- **適用ダークパターン**: 事前選択のみ

#### 中度タスク（電子レンジカテゴリ）
- **対象カテゴリ**: 電子レンジ（商品ID: 207-211） - 合計5商品
- **正解商品**: 商品ID 209（電子レンジ クイックウォーム プロ）
- **タスク**: 指定カテゴリから最安SKUを1点選び、決済完了まで操作する
- **適用ダークパターン**: 事前選択、偽の希少性、偽の社会的証明、隠れ費用

#### 重度タスク（加湿器カテゴリ）
- **対象カテゴリ**: 加湿器（商品ID: 204-206, 214-217） - 合計7商品
- **正解商品**: 商品ID 206（加湿器 モイストエアー スタンダード）- デフォルト表示で3番目に配置
- **タスク**: 指定カテゴリから最安SKUを1点選び、決済完了まで操作する
- **適用ダークパターン**: 全ダークパターンを適用

#### 実験の流れ
1. **事前同意書**: 研究参加に関する事前同意書に記入・送信（`/consent`）
2. **認知スタイル問診票**: 30個の質問に「はい」「いいえ」で回答（`/survey`）
3. **軽度タスク**: 掃除機カテゴリから最安SKUを選択し、購入完了まで操作
   - 完了後、セッションIDを表示し、次のタスクへ進む
4. **中度タスク**: 電子レンジカテゴリから最安SKUを選択し、購入完了まで操作
   - 完了後、セッションIDを表示し、次のタスクへ進む
5. **重度タスク**: 加湿器カテゴリから最安SKUを選択し、購入完了まで操作
   - 完了後、すべてのタスク完了画面を表示し、参加者IDとアンケートリンクを表示

各タスクは独立して実施され、強度レベルごとに異なるカテゴリを使用することで、カテゴリの影響を排除し、強度レベルの違いによる影響を明確に測定します。

### UI再構成タスク
本アプリは「**認知スタイル×UI再構成タスク**」の実験を実施するためのUIビルダーツールを提供します。

#### 実験の目的
この実験は、**「人は自分の認知のクセ（認知スタイル）を、UIを構築する際にも無意識に反映させるのではないか？」**という仮説を検証するためのものです。

#### UIビルダーの機能
- **パーツライブラリ**: 被験者が使用できるUIパーツを提供
  - **視覚的要素**: 巨大な「契約」ボタン、極小の「キャンセル」リンクなど
  - **言語的要素**: 「今すぐ無料で体験（注：3日後に自動課金）」といった紛らわしい文言
  - **デコイ（おとり）**: 全く関係ない華やかな広告バナー
  - **構造的要素**: 規約が書かれた長いスクロールボックス
- **ドラッグ&ドロップ機能**: HTML5のネイティブDnD APIを使用して、パーツをキャンバスに配置
- **キャンバス編集**: 配置したパーツの削除や位置調整が可能
- **エクスポート機能**: 作成したUI設計をJSON形式でエクスポート

#### 実験の流れ
1. **事前準備**: 被験者の認知スタイルを測定(認知スタイル)
2. **タスク指示**: 被験者に「ユーザーが意図せず有料プランを選択してしまうような、配置の工夫」を考えて、UIパーツを組み合わせるよう指示
3. **UI構築**: UIビルダーツールを使用して、被験者がUIを構築
4. **データ収集**: 作成されたUIをエクスポートし、認知スタイルと照らし合わせて分析
   - **場依存型**: 視覚的な「目立ち」を利用する傾向（色の強弱や大きなバナーで注意を逸らす配置）
   - **場独立型**: 構造的な「複雑さ」を利用する傾向（階層を深くしたり、論理的に紛らわしい文言を配置）

#### アクセス方法
トップページ（`/`）から「🎨 UI再構成タスク」リンクをクリックして、UIビルダーページ（`/ui-builder`）にアクセスできます。

## ダークパターンの強度レベルと実験設計

ダークパターンは、**3つの強度レベル**で段階的に制御されます。実験は以下の順序で実施されます：

1. **軽度 (`low`)タスク**: 掃除機カテゴリから最安SKUを選択し、購入完了まで操作
2. **中度 (`medium`)タスク**: 電子レンジカテゴリから最安SKUを選択し、購入完了まで操作
3. **重度 (`high`)タスク**: 加湿器カテゴリから最安SKUを選択し、購入完了まで操作

### 強度レベルと対象カテゴリ

- **軽度 (`low`)**: 掃除機カテゴリ（商品ID: 201-203） - 合計3商品 - 一部のダークパターンのみ（見落としが発生しやすいレベル）
- **中度 (`medium`)**: 電子レンジカテゴリ（商品ID: 207-211） - 合計5商品 - 中程度のダークパターン
- **重度 (`high`)**: 加湿器カテゴリ（商品ID: 204-206, 214-217） - 合計7商品 - 全ダークパターンを適用（正解商品はデフォルト表示で3番目に配置）

各強度レベルで、**対象カテゴリが自動的に設定**され、そのカテゴリの商品のみが表示されます。強度レベルは、`PatternToggle`コンポーネントのドロップダウンメニューから切り替えることができます。

### 強度レベル別の適用ダークパターン

#### 軽度 (`low`)
- **適用ダークパターン**: 事前選択のみ
  - 事前選択（Preselection）: 低価格オプション（延長保証）のみ事前選択
- **目的**: 見落としが発生しやすいレベル（最低限のダークパターン）

#### 中度 (`medium`)
- **適用ダークパターン**: 偽の希少性、偽の社会的証明、隠れ費用
  - 偽の希少性（FakeScarcity）: 標準的なタイマー（10分、残り3個）
  - 偽の社会的証明（FakeSocialProof）: 標準的な表示（1,247人、98%満足度）
  - 隠れ費用（HiddenCosts）: 送料が高いSKUを持つ商品を表示（通常500円より高い送料を適用）

#### 重度 (`high`)
- **適用ダークパターン**: 全ダークパターンを適用
  - 偽の希少性（FakeScarcity）: 強力なタイマー（5分、残り1個）、緊急性を強調
  - 偽の社会的証明（FakeSocialProof）: 強力な表示（3,247人、99%満足度、追加のレビュー）
  - 隠れ費用（HiddenCosts）: 送料が高いSKUを持つ商品を表示（通常500円より高い送料を適用、強力な警告）
  - こっそり追加（Sneaking）: 1秒後に表示、3秒後に再表示、強力な視覚的強調
  - 比較妨害（ComparisonPrevention）: 強力な価格表示の混乱、追加の警告メッセージ
  - 視覚的妨害（VisualInterference）: 正解商品を目立たなくし、ハズレ商品を目立たせる
  - 妨害（Obstruction）: 正解商品へのアクセスを困難にする

## 実装されているダークパターン

本アプリケーションで使用されているダークパターンは以下の8つです。各ダークパターンは特定の認知バイアスと関連付けられています。

### 1. 偽の社会的証明 (Fake Social Proof) & 社会的影響（Social Influence）
- **コード名**: `fake_social_proof`
- **対象認知スタイル**: 言語思考型、物体視覚思考型
- **適用箇所**: 商品詳細（ハズレ商品のみ）、カート、決済画面
- **実装内容**: ハズレ商品（商品102、103、104、105）の詳細ページにのみ、偽の購入者数・満足度・レビューを表示し、社会的証明を演出
- **心理的効果**: 社会的証明バイアス、FOMO（見逃しの恐怖）

### 2. 偽の希少性 (Fake Scarcity) & 希少性バイアス
- **コード名**: `fake_scarcity`
- **対象認知スタイル**: 物体視覚思考型
- **適用箇所**: 商品詳細（ハズレ商品のみ）、カート、決済画面
- **実装内容**: 
  - ハズレ商品（商品102、103、104、105）の詳細ページにのみ適用
  - 在庫残り3個の表示
  - 在庫の少なさを強調する視覚的表示
- **心理的効果**: 希少性バイアス、錯在庫認識

### 3. 偽の緊急性 (Fake Urgency) & 希少性バイアス
- **コード名**: `fake_urgency`（`fake_scarcity`と統合実装）
- **対象認知スタイル**: 物体視覚思考型
- **適用箇所**: 商品詳細（ハズレ商品のみ）、カート、決済画面
- **実装内容**: 
  - ハズレ商品（商品102、103、104、105）の詳細ページにのみ適用
  - 10分間のカウントダウンタイマー（ループ、0になったら600秒にリセット）
  - 「セール終了まで」という時間的プレッシャーを表示
  - 「今すぐ購入しないと機会を逃します！」という緊急性を煽るメッセージ
  - ページ毎のラップタイム（`urgency_to_purchase_ms`）をログ記録
- **心理的効果**: 時間的圧力、FOMO（見逃しの恐怖）、即決購買の促進
- **注意**: Fake Scarcityコンポーネントに統合されて実装されています

### 4. 比較妨害 (Comparison Prevention) & 利用可能性ヒューリスティック
- **コード名**: `comparison_prevention`
- **対象認知スタイル**: 空間視覚思考型
- **適用箇所**: 商品詳細ページ
- **実装内容**: 
  - **仕様順序の変更**: 商品ごとに仕様項目の表示順を変更（`specOrder`）し、商品間の直接比較を困難にする
  - **在庫切れ操作**: パターン有効時、ハズレ商品（102, 103, 104, 105, 202, 203, 204, 205, 207, 208）の最安SKUを在庫切れに設定し、実質的に高価格SKUしか購入できない状態にする
  - **正解商品**: 商品101（空気清浄機）、商品201（掃除機）、商品206（加湿器）、商品209（電子レンジ）は全SKU在庫あり
- **心理的効果**: 決定麻痺、認知的負荷、選択肢の制限、希少性の誤認

### 5. 妨害 (Obstruction) & 利用可能性ヒューリスティック
- **コード名**: `obstruction`
- **対象認知スタイル**: 空間視覚思考型
- **適用箇所**: 商品一覧ページ（商品ID 101のみ）、商品詳細ページ（商品ID 101, 201, 204, 207）
- **実装内容**: 
  - **商品一覧ページ（商品ID: 101のみ）**:
    - クリック可能領域を透明なオーバーレイ（`position: absolute`）で被せ、幅を70%に制限（3割減）
    - 元のLink要素は`pointerEvents: 'none'`で無効化
    - 透明なオーバーレイは左側15%のマージンから幅70%で配置され、この領域のみがクリック可能
    - 商品カードの左右各15%の領域はクリックしても遷移しない
  - **商品詳細ページ（商品ID: 101, 201, 206, 209）**:
    - 正解商品（商品101：エアフロー ライト 200、商品201：掃除機、商品206：加湿器、商品209：電子レンジ）に適用
    - **ボタン配置の妨害（正解商品の目印）**: 
      - **「今すぐ購入」ボタンを右上に配置**（通常とは異なる位置で、正解商品の目印となる）
      - 「戻る」ボタンを左下に配置
      - 「カートに追加」ボタンを右下に配置
      - ボタンのサイズや不透明度は通常の商品と同じだが、配置が異なることで正解商品を識別可能にする
  - **重要**: この配置の違いは、正解商品を識別するための目印として機能する。被験者は、商品詳細ページで「今すぐ購入」ボタンが右上に配置されている商品が正解商品であることを理解する必要がある
- **心理的効果**: ナビゲーションの困難化、購買意思の減退、空間的混乱、クリック領域の縮小による操作の困難化

### 6. 視覚的妨害 (Visual Interference) & アンカリング、利用可能性ヒューリスティック
- **コード名**: `visual_interference`
- **対象認知スタイル**: 物体視覚思考型、空間視覚思考型
- **適用箇所**: 商品一覧、商品詳細ページ
- **実装内容**: 
  - **正解商品（商品101, 201, 206, 209）を目立たなくする**:
    - 商品一覧での不透明度を下げる（85%）
    - 商品名や価格のフォントサイズを小さく
    - カードの影や強調効果を弱める
    - 商品詳細ページでの価格表示を目立たない色・位置に
  - **ハズレ商品（商品103、102、104、105）を目立たせる**:
    - 商品一覧での強調（ハイライト、大きめのフォント）
    - 商品詳細ページでの価格を大きく目立つように表示
    - SKU価格表示の騙し: ハズレ商品の高価格SKUを「お得！」や「人気」などのラベル付きで目立たせ、低価格SKUを控えめに表示
  - **ハズレ商品間の差別化**:
    - 商品103は「高性能」を強調
    - 商品102は「高性能」を強調
    - 商品104、105も同様に強調表示
    - それぞれ異なる強調方法で誘導
- **心理的効果**: 注意の逸らし、正解商品の発見困難化、ハズレ商品への誘導

### 7. 事前選択 (Preselection) & 現状維持バイアス（デフォルト効果）
- **コード名**: `preselection`
- **対象認知スタイル**: 空間視覚思考型
- **適用箇所**: 商品詳細、カート、決済画面
- **実装内容**: 
  - 保証（2,000円）、保険（1,500円）、ニュースレター、プレミアムサポート（3,000円）をデフォルトでON
  - 「おすすめ」バッジで推奨を演出
- **心理的効果**: デフォルト効果、現状維持バイアス

### 8. 隠れ費用 (Hidden Costs) & サンクコストの誤謬
- **コード名**: `hidden_costs`
- **対象認知スタイル**: 言語思考型
- **適用箇所**: 決済画面（中度・重度のみ）
- **実装内容**: 
  - 最も安いSKUで購入できるはずが、送料が通常500円より高い（1,200円〜3,500円）SKUを持つ商品を表示
  - **中度**: 選択されたSKUの送料が高い場合、決済画面で送料が高いことを警告表示（「通常送料¥500ですが、このSKUは送料が¥Xとなります」）
  - **重度**: 警告表示なしで、最初から高い送料を合計に含める（ヌルっと総量を追加）
  - 在庫切れではなく、送料が高くて結果的に正解商品にはならない商品群を提供
  - 商品ID 210-211（電子レンジ、送料3,500円・2,500円）: 中度タスクで使用
  - 商品ID 214-215（加湿器、送料2,200円・2,000円）: 重度タスクで使用
- **心理的効果**: アンカリングバイアス、サンクコストの誤謬

### ダークパターンの適用場所まとめ

| ダークパターン | 商品一覧 | 商品詳細 | カート | 決済画面 |
|---------------|---------|---------|--------|---------|
| 偽の社会的証明 | - | ✓* | ✓ | ✓ |
| 偽の希少性 | - | ✓* | ✓ | ✓ |
| 偽の緊急性 | - | ✓* | ✓ | ✓ |
| 比較妨害（仕様順序変更・在庫切れ操作） | - | ✓ | - | - |
| 妨害（商品101のみ） | - | ✓* | - | - |
| 視覚的妨害 | ✓ | ✓ | - | - |
| 事前選択 | - | ✓ | ✓ | - |
| 隠れ費用 | - | - | - | ✓* |

\* 商品101（エアフロー ライト 200）のみに適用（Obstruction）
\*\* 偽の社会的証明、偽の希少性、偽の緊急性は、ハズレ商品（商品102、103、104、105）の詳細ページにのみ適用
\*\*\* 隠れ費用は中度・重度のみで有効化（軽度では無効）

### ログ収集機能
以下のログデータをバックエンドで収集します：

**セッションIDから選択されたSKUを特定する方法**:
- セッションID（例: `session_1234567890_abc123`）をキーとして、バックエンドのログデータから`decision_event`イベントを検索することで、選択されたSKU（`sku_id`）を特定できます
- `decision_event`の`data`フィールドに`sku_id`が含まれており、各セッションで選択されたSKUの履歴を追跡できます
- `purchase_complete`イベントの`data`フィールドにも`selected_sku_id`が含まれているため、最終的に選択されたSKUを確認できます

#### 主要メトリクス
1. **最終支払額の最適性 (`price_optimality`)**: (実最安価格 − 支払額) - 負値大ほど影響大
2. **誤選択率 (`wrong_selection_rate`)**: 最安以外の SKU 購入割合 (0.0-1.0)
3. **オプション付与誘導率 (`option_maintenance_rate`)**: 既定 ON オプション維持割合 (0.0-1.0)
4. **比較行動 (`comparison_actions`)**: 一覧 ↔ 詳細往復回数
5. **時間・負荷**:
   - `total_time_ms`: 総所要時間（ミリ秒）
   - `page_time_ms`: 画面毎の滞在時間（オブジェクト）
6. **ログイベント**:
   - `countdown_purchase_rate`: カウントダウン提示後の確定割合 (0 or 1)
   - `hidden_costs_revealed`: 隠れ費用開示の有無 (boolean)
   - `urgency_to_purchase_ms`: 緊急性提示から購入までの時間（ミリ秒、null可）
   - `costs_reveal_to_purchase_ms`: 費用開示から購入までの時間（ミリ秒、null可）

#### ログデータの詳細構造

##### セッション開始 (`session_start`)
```json
{
  "session_id": "session_1234567890_abc123",
  "participant_id": "12345678",
  "event_type": "session_start",
  "timestamp": "2025-11-16T12:00:00.000Z",
  "data": {
    "user_agent": "...",
    "screen_width": 1920,
    "screen_height": 1080
  }
}
```

##### ページ遷移 (`page_view`)
```json
{
  "session_id": "session_1234567890_abc123",
  "participant_id": "12345678",
  "event_type": "page_view",
  "timestamp": "2025-11-16T12:00:05.000Z",
  "data": {
    "page_name": "product_list",
    "previous_page": null,
    "time_spent_ms": 0
  }
}
```

##### 意思決定イベント (`decision_event`)
SKU選択、オプション選択、追加商品削除などの意思決定に直接関与する操作を記録します。

**SKU選択**:
```json
{
  "session_id": "session_1234567890_abc123",
  "participant_id": "12345678",
  "event_type": "decision_event",
  "timestamp": "2025-11-16T12:01:00.000Z",
  "data": {
    "decision_type": "sku_selection",
    "product_id": 101,
    "sku_id": "e101-1",
    "sku_price": 12800,
    "is_lowest_price": true,
    "was_default": false
  }
}
```

**オプション選択**:
```json
{
  "session_id": "session_1234567890_abc123",
  "participant_id": "12345678",
  "event_type": "decision_event",
  "timestamp": "2025-11-16T12:02:00.000Z",
  "data": {
    "decision_type": "option_toggle",
    "options": {
      "warranty": true,
      "insurance": false,
      "newsletter": true,
      "premiumSupport": false
    },
    "default_options": {
      "warranty": true,
      "insurance": true,
      "newsletter": true,
      "premiumSupport": true
    },
    "option_changes": {
      "warranty": {
        "was_default": true,
        "is_selected": true,
        "changed": false
      },
      "insurance": {
        "was_default": true,
        "is_selected": false,
        "changed": true
      }
    }
  }
}
```

##### 購入完了 (`purchase_complete`)
```json
{
  "session_id": "session_1234567890_abc123",
  "participant_id": "12345678",
  "event_type": "purchase_complete",
  "timestamp": "2025-11-16T12:05:00.000Z",
    "data": {
      "product_id": 101,
      "base_price": 12800,
      "actual_paid_price": 12800,
      "selected_sku_id": "e101-1",
      "selected_sku_price": 12800,
    "is_lowest_price": true,
    "option_price": 6500,
    "hidden_fees": 1150,
    "total_paid": 17550,
      "lowest_price": 12800,
      "lowest_total": 13950,
    "price_optimality": -6500,
    "selected_options": {
      "warranty": true,
      "insurance": true,
      "newsletter": true,
      "premiumSupport": true
    },
    "total_time_ms": 300000,
    "navigation_count": 5,
    "filter_sort_count": 2,
    "comparison_actions": 3,
    "option_maintenance_rate": 1.0,
    "wrong_selection_rate": 0.0,
    "countdown_purchase_rate": 1,
    "hidden_costs_revealed": true,
    "used_patterns": [
      {"name": "fake_social_proof", "location": "product_list"},
      {"name": "fake_scarcity", "location": "product_detail"},
      {"name": "comparison_prevention", "location": "product_detail"}
    ],
    "urgency_to_purchase_ms": 120000,
    "costs_reveal_to_purchase_ms": 5000,
    "page_time_ms": {
      "product_list": 45000,
      "product_detail": 200000,
      "cart": 30000,
      "checkout": 25000
    }
  }
}
```

## 起動手順 (ローカル)

### 前提条件
- Docker と Docker Compose がインストールされていること
- Node.js と PHP がインストールされていること（直接実行する場合）

### Docker Compose を使用する場合
1. このリポジトリをクローン
2. `docker-compose up --build`
3. ブラウザでアクセス
   - フロントエンド: http://localhost:3000
   - バックエンド API: http://localhost:8000/api

### 個別に起動する場合

#### バックエンド
```bash
cd backend
composer install
php artisan migrate
php artisan serve
```

#### フロントエンド
```bash
cd frontend
npm install
npm run dev
```

## Render へのデプロイ手順

### 1. Render アカウントの準備
1. [Render](https://render.com) でアカウントを作成
2. GitHub リポジトリと連携

### 2. バックエンドサービスのデプロイ
1. Render ダッシュボードで「New Web Service」を選択
2. GitHub リポジトリを選択
3. 以下の設定を行う：
   - **Name**: `dpec-backend`
   - **Runtime**: `PHP`
   - **Build Command**: 
     ```bash
     cd backend && composer install --no-dev --optimize-autoloader && php artisan migrate --force && php artisan config:cache && php artisan route:cache
     ```
   - **Start Command**: 
     ```bash
     cd backend && php artisan serve --host=0.0.0.0 --port=$PORT
     ```
   - **Environment Variables**:
     - `APP_ENV=production`
     - `APP_DEBUG=false`
     - `DB_CONNECTION=sqlite`
     - `DB_DATABASE=/opt/render/project/src/backend/database/database.sqlite`
     - `LOG_CHANNEL=stack`

4. 「Create Web Service」をクリック

### 3. フロントエンドサービスのデプロイ
1. Render ダッシュボードで「New Static Site」を選択
2. GitHub リポジトリを選択
3. 以下の設定を行う：
   - **Name**: `dpec-frontend`
   - **Build Command**: 
     ```bash
     cd frontend && npm ci && npm run build
     ```
   - **Publish Directory**: `frontend/dist`
   - **Environment Variables**:
     - `VITE_API_URL=https://[your-backend-service-name].onrender.com/api`
     （バックエンドのURLを設定）

4. 「Create Static Site」をクリック

### 4. データベースの初期化
バックエンドサービスが起動した後、マイグレーションが自動的に実行されます。
初回デプロイ時は、Render のシェルから以下を実行してください：

```bash
cd backend
php artisan migrate
```

### 5. 動作確認とテスト

#### 5.1 ローカル環境での動作確認

プロジェクトルートに以下のテストスクリプトが用意されています：

**事前同意書APIのテスト**:
```powershell
.\test_api.ps1
```

**ログデータAPIのテスト**:
```powershell
.\test_logs.ps1
```

これらのスクリプトは、各APIエンドポイントの動作を包括的にテストし、結果を表示します。

#### 5.2 ログデータの確認方法

デプロイ後、以下のエンドポイントでログデータを確認できます：

**ログAPI**:
- **ログ送信**: `POST /api/logs`
- **セッション別ログ取得**: `GET /api/logs/session/{sessionId}`
- **イベントタイプ別ログ取得**: `GET /api/logs/event/{eventType}`
- **評価指標取得**: `GET /api/logs/session/{sessionId}/metrics`
- **ログ可視化**: `GET /api/logs/session/{sessionId}/visualization`
- **集計データ取得**: `GET /api/logs/analytics?start_date=YYYY-MM-DD&end_date=YYYY-MM-DD`

**事前同意書API**:
- **同意書一覧取得**: `GET /api/consent-forms`（最新20件）
- **同意書保存**: `POST /api/consent-forms`
- **参加者IDで同意書取得**: `GET /api/consent-forms/participant/{participantId}`

詳細なデプロイ後の運用方法については、`DEPLOY.md`の「デプロイ後の運用」セクションを参照してください。

## データ構造

### 商品データ
商品データは `frontend/src/data/products.js` で静的に管理されています。
各商品には複数の SKU（バリエーション）が含まれており、価格が異なります。

**商品データの保存先**: `frontend/src/data/products.js`

### ログデータ

#### データベース設計

バックエンドの `user_logs` テーブルに以下の情報が保存されます：

- `id`: プライマリキー（自動増分）
- `session_id`: セッション識別子（文字列、最大100文字、インデックス付き）
- `event_type`: イベントタイプ（文字列、最大50文字、インデックス付き）
  - `session_start`: 実験開始時のセッション情報
  - `page_view`: 各画面への遷移
  - `decision_event`: 意思決定に直接関与する操作（SKU選択、オプション選択、追加商品削除など）
  - `purchase_complete`: 決済完了時
- `timestamp`: イベント発生時刻（タイムスタンプ型）
- `data`: JSON形式のイベントデータ（JSON型、nullable）
  - `participant_id`: テスト参加ID（8桁の乱数、全ログに含まれる）は`data`フィールド内に保存
  - その他のイベント固有のデータも`data`フィールドに保存
- `created_at`, `updated_at`: Laravelのタイムスタンプ（自動管理）

**インデックス**:
- `session_id`単独インデックス
- `event_type`単独インデックス
- `session_id`と`event_type`の複合インデックス（検索性能向上）
- `created_at`インデックス（時系列クエリの最適化）

**設計意図**:
- **JSONデータの柔軟性**: `data`フィールドをJSON型にすることで、イベントタイプごとに異なる構造のデータを柔軟に保存可能
- **participant_idの保存**: `data`フィールド内に保存することで、すべてのイベントで一貫して参加者を識別可能
- **検索性能**: セッションIDやイベントタイプでの検索を高速化するため、適切なインデックスを設定
- **スケーラビリティ**: SQLiteを使用することで、開発環境でのセットアップを簡素化しつつ、必要に応じてPostgreSQLやMySQLへの移行が容易

#### APIエンドポイント設計

**ログ送信**:
- `POST /api/logs`
  - 単一のログイベントを受信して保存
  - バリデーション: `session_id`, `event_type`, `timestamp`は必須
  - レスポンス: 保存されたログのIDを返却

**事前同意書API**:
- `GET /api/consent-forms`
  - 同意書一覧を取得（最新20件、クエリパラメータ`limit`で件数を変更可能）
  - レスポンス: 同意書のリスト（作成日時の降順）
- `POST /api/consent-forms`
  - 事前同意書データを受信して保存
  - バリデーション: `consent_checks`（8つのチェックボックス）、`risk_understanding`（はい/いいえ）、`ec_usage_frequency`、`final_consent`は必須
  - レスポンス: 保存された同意書のIDを返却
- `GET /api/consent-forms/participant/{participantId}`
  - 参加者IDで同意書を取得（最新1件）
  - レスポンス: 同意書データ

**ログ取得**:
- `GET /api/logs/session/{sessionId}`
  - セッションIDでログを取得（時系列順）
  - 用途: 特定セッションの全イベントを追跡
  
- `GET /api/logs/event/{eventType}`
  - イベントタイプでログを取得（新しい順）
  - 用途: 特定タイプのイベント（例: `purchase_complete`）を一覧表示

**評価指標取得**:
- `GET /api/logs/session/{sessionId}/metrics`
  - セッションIDで評価指標を計算して取得
  - 返却データ:
    - `price_optimality`: 最終支払額の最適性（最安価格 - 支払額）
    - `wrong_selection_rate`: 誤選択率（最安SKU以外を選択した割合）
    - `option_maintenance_rate`: オプション維持率（デフォルトONオプションが維持された割合）
    - `comparison_actions`: 比較行動量（一覧と詳細の往復回数）
    - `decision_time_ms`: 意思決定時間（セッション開始から購入確定まで）
    - `urgency_to_purchase_ms`: 緊急性提示後行動時間（カウントダウン表示後から購入確定まで）
  - 用途: ダークパターンの影響を定量的に評価

**ログ可視化**:
- `GET /api/logs/session/{sessionId}/visualization`
  - セッションIDでログの可視化データを取得
  - 返却データ:
    - `session_id`: セッションID
    - `total_events`: 総イベント数
    - `events`: 全イベントの詳細リスト
    - `summary`: イベント種別ごとのサマリー
    - `metrics`: 評価指標
  - 用途: ログデータの視認性向上、デバッグ、分析

**集計データ取得**:
- `GET /api/logs/analytics?start_date=YYYY-MM-DD&end_date=YYYY-MM-DD`
  - 日付範囲でログを集計
  - 返却データ:
    - `event_type_stats`: イベントタイプごとの件数
    - `session_stats`: セッションごとの統計（イベント数、開始時刻、終了時刻）
    - `total_logs`: 総ログ数
  - 用途: 実験データの分析、ダッシュボード表示

**設計意図**:
- **一括送信対応**: フロントエンドから購入完了時に一括で送信されるログを効率的に処理
- **柔軟な分析**: セッション単位、イベントタイプ単位、期間単位で柔軟にデータを取得可能
- **バリデーション**: 不正なデータの混入を防止し、データ品質を保証

**ログデータの確認方法**:

##### 方法0: テストスクリプトを使用（推奨）

プロジェクトルートに以下のテストスクリプトがあります：

**事前同意書のテスト**:
```powershell
.\test_api.ps1
```

**ログデータのテスト**:
```powershell
.\test_logs.ps1
```

これらのスクリプトは、各APIエンドポイントの動作を包括的にテストし、結果を表示します。

##### 方法1: Dockerログでバックエンドの処理ログを確認

```bash
# バックエンドのログをリアルタイムで確認
docker-compose logs -f backend

# 最新50行のログを表示
docker-compose logs --tail=50 backend

# エラーや例外を検索
docker-compose logs backend | findstr /i "error exception timeout"
```

##### 方法2: APIエンドポイントでログデータを取得（ブラウザまたはPowerShell）

**ベースURL**: `http://localhost:8000/api` または `http://127.0.0.1:8000/api`

**重要**: PowerShellの`curl`（`Invoke-WebRequest`のエイリアス）は長いJSONを省略表示します。完全な内容を表示するには、`Invoke-RestMethod`を使用してください。

**推奨方法（PowerShell）**:
```powershell
# Invoke-RestMethodを使用（JSONが自動的にパースされる）
Invoke-RestMethod -Uri "http://localhost:8000/api/logs/session/{sessionId}" | ConvertTo-Json -Depth 10

# 集計データを取得
Invoke-RestMethod -Uri "http://localhost:8000/api/logs/analytics" | ConvertTo-Json -Depth 10

# 特定イベントタイプのログを取得
Invoke-RestMethod -Uri "http://localhost:8000/api/logs/event/purchase_complete" | ConvertTo-Json -Depth 10
```

**ブラウザで確認**:
1. **集計データを取得**（推奨）:
   ```
   GET http://localhost:8000/api/logs/analytics
   ```
   または日付範囲を指定:
   ```
   GET http://localhost:8000/api/logs/analytics?start_date=2025-11-18&end_date=2025-11-18
   ```
   ブラウザで開く: [http://localhost:8000/api/logs/analytics](http://localhost:8000/api/logs/analytics)

2. **特定セッションのログを取得**:
   ```
   GET http://localhost:8000/api/logs/session/{sessionId}
   ```
   例: `http://localhost:8000/api/logs/session/session_1234567890_abc123`

3. **特定イベントタイプのログを取得**:
   ```
   GET http://localhost:8000/api/logs/event/{eventType}
   ```
   例（購入完了イベント）: `http://localhost:8000/api/logs/event/purchase_complete`
   例（セッション開始）: `http://localhost:8000/api/logs/event/session_start`
   例（ページ閲覧）: `http://localhost:8000/api/logs/event/page_view`

**注意**: PowerShellの`curl`（`Invoke-WebRequest`）を使用する場合、`Content`プロパティが省略されることがあります。完全な内容を表示するには、以下のようにします：
```powershell
# Invoke-WebRequestを使用する場合
$response = Invoke-WebRequest -Uri "http://localhost:8000/api/logs/session/{sessionId}" -UseBasicParsing
$response.Content | ConvertFrom-Json | ConvertTo-Json -Depth 10
```

##### 方法3: データベースを直接確認

- **SQLiteデータベースファイル**: `backend/database/database.sqlite`
- SQLiteクライアント（例: DB Browser for SQLite）を使用して直接確認可能
- テーブル名: `user_logs`

**注意**: 本番環境（Render）では、`localhost:8000`をバックエンドサービスの実際のURLに置き換えてください。

## 開発

### ログ収集機能の拡張
`frontend/src/contexts/LoggingContext.jsx` を編集して、新しいログイベントを追加できます。

### 商品データの変更
`frontend/src/data/products.js` を編集して商品データを変更できます。

## アンケート

決済完了後に表示されるアンケートは、環境変数 `VITE_SURVEY_URL` でGoogle FormのURLを設定します。

### アンケートの推奨質問項目

1. **認知スタイル調査の結果**
   - 「あなたの認知スタイル調査の結果を教えてください。」
     - テキスト入力欄
     - **注意**: この結果は、トップページの「📝 認知スタイルアンケート」リンクからアクセスできるアンケートページ（`/survey`）で回答できます。アンケートページでは、30個の質問（物体視覚思考10項目、言語思考10項目、空間視覚思考10項目）を「はい」「いいえ」で回答し、完了ボタンを押すと「質問番号x1」または「質問番号x0」の形式で結果が表示されます（例: `1x1 2x0 3x1 ...`）。この結果をコピーして、Google Formのテキスト入力欄に貼り付けてください。

2. **テスト参加ID**
   - 「決済完了画面に表示されたテスト参加IDを入力してください。」
     - テキスト入力欄（8桁の数字）
     - 例: 12345678

3. **主観的な影響感度の評価**
   - 「あなたは今回の操作課題でダークパターンをどの程度見つけることができたと考えていますか?」（5段階評価）

4. **特に影響した要素**
   - 「今回の操作課題をやっている最中で、特に気になったダークパターンについてチェックを入れてください」
   (複数回答可
     - 偽の社会的証明（他の購入者数・満足度・レビューの表示）
     - 偽の希少性（在庫残りが少ないという表示）
     - 偽の緊急性（カウントダウンタイマーやセール終了の表示）
     - 比較妨害（仕様の比較のしづらさ、在庫切れによる選択肢の制限とそれによる比較困難）
     - 妨害（購入ボタンの配置や操作のしづらさ）
     - 視覚的妨害（商品の目立ちやすさの操作、価格表示の騙し）
     - 事前選択（デフォルトでONになっているオプション）
     - 隠れ費用（後から表示される送料・手数料）
     - その他

5. **自由記述**
   - 「その他、ご意見・ご感想がございましたらお聞かせください」

### 環境変数の設定方法

#### ローカル開発環境
`.env` ファイルを作成（`frontend/.env`）:
```
VITE_SURVEY_URL=https://docs.google.com/forms/d/e/YOUR_FORM_ID/viewform
```

#### 本番環境（Render）
Render ダッシュボードの環境変数設定で追加:
- **Key**: `VITE_SURVEY_URL`
- **Value**: `https://docs.google.com/forms/d/e/YOUR_FORM_ID/viewform`

## ファイルの保存先

- **README.md**: プロジェクトルート（`dpec/README.md`）
- **商品データ**: `frontend/src/data/products.js`
- **ログデータ（データベース）**: `backend/database/database.sqlite`
- **ログデータ（API）**: `http://localhost:8000/api/logs/analytics`

## 注意事項
- このアプリケーションは認知スタイルにおけるダークパターンの影響感度検証を目的としています
- ログデータには個人を特定できる情報を含めないでください
- 本番環境では適切なセキュリティ対策を実施してください

## UI再構成タスク - ライブラリパーツの設計意図

UI再構成タスクでは、被験者が認知スタイル・認知バイアスを意識したダークパターンを設計することを目的としています。ライブラリパーツには、以下の認知スタイル・認知バイアスを意識した要素が含まれています。

### 認知バイアス要素の設計意図

#### 1. アンカリング効果（Anchoring Effect）
- **パーツ名**: アンカリング価格表示
- **対象画面**: 商品一覧、商品詳細
- **設計意図**: 最初に見た価格（通常価格）に判断が影響される認知バイアスを利用。高い通常価格を表示することで、割引価格をより魅力的に見せる
- **対象認知スタイル**: 言語思考型、物体視覚思考型（数値情報の処理に影響）

#### 2. フレーミング効果（Framing Effect）
- **パーツ名**: ポジティブフレーミング、ネガティブフレーミング
- **対象画面**: 商品詳細、カート、決済画面
- **設計意図**: 同じ情報でも表現方法（得られる vs 失う）で判断が変わる認知バイアスを利用。ポジティブフレーミングでは「得られる利益」、ネガティブフレーミングでは「失う損失」を強調
- **対象認知スタイル**: 言語思考型（言語表現の処理に影響）

#### 3. 損失回避（Loss Aversion）
- **パーツ名**: 損失回避メッセージ
- **対象画面**: カート、決済画面
- **設計意図**: 失うことへの恐怖が得ることへの喜びよりも強いという認知バイアスを利用。カートから削除されることへの警告を表示
- **対象認知スタイル**: 全認知スタイル（感情的な判断に影響）

#### 4. 即時性（Immediacy）
- **パーツ名**: 即時性タイマー
- **対象画面**: 商品詳細、カート、決済画面
- **設計意図**: 時間的プレッシャーにより即座の行動を促す。カウントダウンタイマーで緊急性を演出
- **対象認知スタイル**: 物体視覚思考型（視覚的な時間表現に影響）

#### 5. 選択肢の過多（Choice Overload）
- **パーツ名**: 選択肢過多
- **対象画面**: 商品詳細、決済画面
- **設計意図**: 選択肢が多すぎると判断が困難になる認知バイアスを利用。多数のオプションを提示することで、デフォルト選択や推奨選択に従いやすくする
- **対象認知スタイル**: 空間視覚思考型（情報整理の困難さに影響）

#### 6. コントラスト効果（Contrast Effect）
- **パーツ名**: コントラスト比較
- **対象画面**: 商品一覧、商品詳細
- **設計意図**: 比較対象によって判断が変わる認知バイアスを利用。高価格商品と比較することで、対象商品をより魅力的に見せる
- **対象認知スタイル**: 空間視覚思考型（視覚的な比較処理に影響）

#### 7. デフォルト効果の強化（Default Bias）
- **パーツ名**: デフォルト効果強化
- **対象画面**: 商品詳細、カート、決済画面
- **設計意図**: デフォルト選択に従いやすい認知バイアスを強化。事前選択されたオプションを視覚的に強調し、「おすすめ」として提示
- **対象認知スタイル**: 空間視覚思考型（デフォルト状態の認識に影響）

### 各画面タイプの例

UI再構成タスクでは、各画面タイプ（商品一覧、商品詳細、カート、決済画面）について、ライブラリパーツから作成できる例を2つずつ用意することを推奨します。これにより、被験者が認知スタイル・認知バイアスを意識したダークパターンを設計する際の参考となります。

**注意**: サイト上（UI再構成タスク画面）では、これらの認知スタイル・認知バイアスの説明は明示されません。被験者が自ら認知スタイル・認知バイアスを意識してダークパターンを設計することを目的としているためです。


# Dark Pattern Components - Cognitive Mapping Implementation

This directory contains React components implementing various dark patterns with cognitive mapping targeting specific thinking styles.

## Components Overview

### 1. FakeSocialProof.jsx
**Target Cognitive Styles:** 言語思考型 (Linguistic), 物体視覚思考型 (Object Visual)
- **Purpose:** Creates false social validation and urgency
- **Activation:** Product list, product detail, cart, checkout
- **Visual Elements:** Live user count, satisfaction percentage, testimonials
- **Psychological Impact:** Social proof bias, FOMO (Fear of Missing Out)

### 2. FakeScarcity.jsx
**Target Cognitive Styles:** 物体視覚思考型 (Object Visual)
- **Purpose:** Creates artificial time pressure and limited availability
- **Activation:** Product list, product detail, cart, checkout
- **Visual Elements:** Countdown timer, stock indicators, urgency messages
- **Psychological Impact:** Scarcity bias, time pressure

### 3. ComparisonPrevention.jsx
**Target Cognitive Styles:** 空間視覚思考型 (Spatial Visual)
- **Purpose:** Makes price comparison difficult through confusing layouts
- **Activation:** Product list (first item only)
- **Visual Elements:** Inconsistent pricing units, confusing feature grids
- **Psychological Impact:** Decision paralysis, cognitive overload

### 4. Preselection.jsx
**Target Cognitive Styles:** 空間視覚思考型 (Spatial Visual)
- **Purpose:** Pre-selects additional options to increase conversion
- **Activation:** Product detail, cart, checkout
- **Visual Elements:** Pre-checked boxes, highlighted "recommended" options
- **Psychological Impact:** Default bias, status quo bias

### 5. HiddenCosts.jsx
**Target Cognitive Styles:** 言語思考型 (Linguistic)
- **Purpose:** Delays/reveals additional costs to manipulate decision making
- **Activation:** Product detail, checkout
- **Visual Elements:** Delayed cost revelation, hidden fees
- **Psychological Impact:** Anchoring bias, sunk cost fallacy

### 6. Sneaking.jsx
**Target Cognitive Styles:** 言語思考型 (Linguistic), 空間視覚思考型 (Spatial Visual)
- **Purpose:** Subtle modal offering additional benefits
- **Activation:** Product detail, checkout
- **Visual Elements:** Modal overlay, benefit highlights
- **Psychological Impact:** Reciprocity, additional value perception

## Usage

Each component accepts a `patternEnabled` prop (boolean) for backward compatibility, but now uses intensity levels (`patternIntensity`) from `PatternContext`:

```jsx
// 後方互換性: patternEnabledプロップも使用可能
<FakeSocialProof patternEnabled={true} />
<FakeScarcity patternEnabled={false} />

// 推奨: PatternContextを使用して強度レベルを管理
// コンポーネントは自動的にPatternContextから強度を取得します
<FakeSocialProof />
<FakeScarcity />
```

### Pattern Intensity Levels

ダークパターンは4つの強度レベルで制御できます：

- **`none`**: ダークパターン無効（クリーンな表示）
- **`low`**: 軽度（控えめなダークパターン、弱い影響）
- **`medium`**: 中度（標準的なダークパターン、中程度の影響）
- **`high`**: 重度（強力なダークパターン、強い影響）

### Pattern Toggle Control

Use the `PatternToggle` component to control all patterns with intensity levels:

```jsx
import PatternToggle from '../components/dark-patterns/PatternToggle';
import { PatternProvider } from '../../contexts/PatternContext';

// PatternProviderでラップして使用
<PatternProvider>
  <PatternToggle />
</PatternProvider>
```

`PatternToggle`コンポーネントは、強度レベルを切り替えられるドロップダウンメニューを提供します。

### Intensity Level Behavior

各ダークパターンコンポーネントは、強度レベルに応じて異なる表示をします：

#### Preselection
- **`none`**: オプションはすべてオフ（クリーンな表示）
- **`low`**: 低価格オプション（延長保証）のみ事前選択
- **`medium`**: 低・中価格オプションと無料オプションを事前選択
- **`high`**: すべてのオプションを事前選択、強力な視覚的強調

#### FakeSocialProof
- **`none`**: 表示なし
- **`low`**: 控えめな購入者数表示（247人、95%満足度）
- **`medium`**: 標準的な表示（1,247人、98%満足度）
- **`high`**: 強力な表示（3,247人、99%満足度、追加のレビュー）

#### FakeScarcity
- **`none`**: 表示なし
- **`low`**: 控えめなタイマー（15分、残り8個）
- **`medium`**: 標準的なタイマー（10分、残り3個）
- **`high`**: 強力なタイマー（5分、残り1個）、緊急性を強調

#### HiddenCosts
- **`none`**: すべての費用を最初から表示（送料500円、手数料200円）
- **`low`**: 1秒後に費用を表示、追加250円
- **`medium`**: 2秒後に費用を表示、追加450円
- **`high`**: 4秒後に費用を表示、追加450円、強力な警告

#### Sneaking
- **`none`**: 表示なし
- **`low`**: 5秒後に表示、10秒後に再表示
- **`medium`**: 3秒後に表示、5秒後に再表示
- **`high`**: 1秒後に表示、3秒後に再表示、強力な視覚的強調

#### ComparisonPrevention
- **`none`**: 表示なし
- **`low`**: 控えめな価格表示の混乱
- **`medium`**: 標準的な価格表示の混乱
- **`high`**: 強力な価格表示の混乱、追加の警告メッセージ

## Integration Points

### ProductList.jsx
- **FakeSocialProof:** Creates urgency and social validation
- **FakeScarcity:** Time pressure and limited availability
- **ComparisonPrevention:** Confusing pricing layout (first product only)

### ProductDetail.jsx
- **FakeSocialProof:** Social validation on product page
- **FakeScarcity:** Time pressure for purchase decision
- **HiddenCosts:** Delayed cost revelation
- **Preselection:** Pre-selected additional options
- **Sneaking:** Additional benefits modal

### Cart.jsx
- **FakeSocialProof:** Final social validation before checkout
- **FakeScarcity:** Urgency to complete purchase
- **Preselection:** Additional services in cart

### Checkout.jsx
- **FakeSocialProof:** Final social validation
- **FakeScarcity:** Final urgency push
- **HiddenCosts:** Reveals additional costs
- **Preselection:** Additional services during checkout
- **Sneaking:** Final attempt to add services

## Styling

All components use consistent styling defined in `DarkPatternStyles.css`:
- **Font:** "Noto Sans JP", sans-serif
- **Primary Colors:** #E84118 (red), #273C75 (blue), #F5F6FA (background)
- **Spacing:** gap: 8px; margin: 8px 0
- **Shadows:** box-shadow: 0 2px 4px rgba(0,0,0,0.1)

## Cognitive Mapping Reference

| Pattern | Stimulus | Target Style |
|----------|-----------|--------------|
| Fake Social Proof | Text + Visual emphasis | 言語思考型, 物体視覚思考型 |
| Fake Scarcity | Red color + Numbers + Timer | 物体視覚思考型 |
| Comparison Prevention | Layout confusion + inconsistent units | 空間視覚思考型 |
| Preselection | Default ON checkbox | 空間視覚思考型 |
| Hidden Costs | Delayed/revealed text | 言語思考型 |
| Sneaking | Subtle modal + wording | 言語思考型, 空間視覚思考型 |

## Ethical Considerations

These components are designed for research and educational purposes to:
1. Study the psychological impact of dark patterns
2. Understand cognitive biases in e-commerce
3. Develop countermeasures and ethical design practices
4. Train developers to recognize and avoid dark patterns

**Important:** These patterns should not be used in production environments without proper ethical review and user consent mechanisms.